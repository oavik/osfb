<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Falling Blocks</title>
<style type="text/css">
* { margin: 0; padding: 0; border: 0; }
span { display: inline-block; border: 1px solid black; }
.i { background: cyan; }
.j { background: blue; }
.l { background: orange; }
.o { background: yellow; }
.s { background: lime; }
.t { background: purple; }
.z { background: red; }
#playfield { background: black; margin-left: auto; margin-right: auto; }
#gameover { display: none; margin-left: auto; margin-right: auto; position: fixed; top: 0; color: white; text-align: center; text-shadow: 1px 1px black; }
#scoreboard { background: black; margin-left: auto; margin-right: auto; color: white; }
#scoreboard div { display: inline; }
#scoreboard div + div { float: right; }
</style>
<script type="text/javascript">
var fieldwidth = 10;
var fieldheight = 20;
var currentpiece = undefined;
var scores = [ 0, 100, 200, 400, 800 ];

var rotations = {
	i: [ [ { y: 0, x: 0 }, { y: 1, x: 0 }, { y: 2, x: 0 }, { y: 3, x: 0 } ],
	     [ { y: 0, x: 0 }, { y: 0, x: 1 }, { y: 0, x: 2 }, { y: 0, x: 3 } ] ],
	j: [ [ { y: 0, x: 0 }, { y: 0, x: 1 }, { y: 0, x: 2 }, { y: 1, x: 2 } ],
	     [ { y: 0, x: 1 }, { y: 1, x: 1 }, { y: 2, x: 0 }, { y: 2, x: 1 } ],
	     [ { y: 0, x: 0 }, { y: 1, x: 0 }, { y: 1, x: 1 }, { y: 1, x: 2 } ],
	     [ { y: 0, x: 0 }, { y: 0, x: 1 }, { y: 1, x: 0 }, { y: 2, x: 0 } ] ],
	l: [ [ { y: 0, x: 0 }, { y: 0, x: 1 }, { y: 0, x: 2 }, { y: 1, x: 0 } ],
	     [ { y: 0, x: 0 }, { y: 0, x: 1 }, { y: 1, x: 1 }, { y: 2, x: 1 } ],
	     [ { y: 0, x: 2 }, { y: 1, x: 0 }, { y: 1, x: 1 }, { y: 1, x: 2 } ],
	     [ { y: 0, x: 0 }, { y: 1, x: 0 }, { y: 2, x: 0 }, { y: 2, x: 1 } ] ],
	o: [ [ { y: 0, x: 0 }, { y: 0, x: 1 }, { y: 1, x: 0 }, { y: 1, x: 1 } ] ],
	s: [ [ { y: 0, x: 1 }, { y: 0, x: 2 }, { y: 1, x: 0 }, { y: 1, x: 1 } ],
	     [ { y: 0, x: 0 }, { y: 1, x: 0 }, { y: 1, x: 1 }, { y: 2, x: 1 } ] ],
	t: [ [ { y: 0, x: 0 }, { y: 0, x: 1 }, { y: 0, x: 2 }, { y: 1, x: 1 } ],
	     [ { y: 0, x: 1 }, { y: 1, x: 0 }, { y: 1, x: 1 }, { y: 2, x: 1 } ],
	     [ { y: 0, x: 1 }, { y: 1, x: 0 }, { y: 1, x: 1 }, { y: 1, x: 2 } ],
	     [ { y: 0, x: 0 }, { y: 1, x: 0 }, { y: 1, x: 1 }, { y: 2, x: 0 } ] ],
	z: [ [ { y: 0, x: 0 }, { y: 0, x: 1 }, { y: 1, x: 1 }, { y: 1, x: 2 } ],
	     [ { y: 0, x: 1 }, { y: 1, x: 0 }, { y: 1, x: 1 }, { y: 2, x: 0 } ] ]
};

function getbounds(piece) {
	piece.height = 0;
	piece.width = 0;
	for (var i = 0; i < 4; i++) {
		if (piece[i].y > piece.height) { piece.height = piece[i].y; }
		if (piece[i].x > piece.width) { piece.width = piece[i].x; }
	}
}

function nextpiece() {
	var pieces = [ 'i', 'j', 'l', 'o', 's', 't', 'z' ];
	var piece = {};
	piece.type = pieces[Math.floor(Math.random() * pieces.length)];
	piece.left = 0;
	piece.top = 0;
	piece.rotation = 0;
	for (var i = 0; i < 4; i++) {
		piece[i] = { y: rotations[piece.type][0][i].y, x: rotations[piece.type][0][i].x };
	}
	getbounds(piece);
	piece.left = Math.floor((fieldwidth / 2) - (piece.width / 2));
	return piece;
}

function cleartimer() { window.clearInterval(window.timer); }
function settimer() { window.timer = window.setInterval(advance, 500); }
function getblock(y, x) { return document.getElementById(y + "-" + x); }
function blocktype(y, x) { return getblock(y,x).className; }
function clearblock(y, x) { if (getblock(y, x)) { getblock(y, x).className = ""; } }
function setblock(y, x, t) { getblock(y, x).className = t; }

function gameover() {
	cleartimer();
	reinit();
	var go = document.getElementById("gameover");
	go.style.display = "block";
}

function clearline(y) {
	for (var x = 0; x < fieldwidth; x++) {
		if (blocktype(y, x) == "") {
			return 0;
		}
	}
	while (y > 0) {
		for (var x = 0; x < fieldwidth; x++) {
			setblock(y, x, blocktype(y - 1, x));
		}
		y--;
	}
	for (var x = 0; x < fieldwidth; x++) {
		clearblock(0, x);
	}
	return 1;
}


function clearlines() {
	var lines = 0;
	for (var y = 0; y < fieldheight; y++) {
		lines += clearline(y);
	}
	return lines;
}

function updatescore() {
	document.getElementById("score").innerHTML = window.score;
	document.getElementById("lines").innerHTML = window.lines;
}

function clearpiece(piece) {
	for (var i = 0; i < 4; i++) {
		clearblock(piece[i].y + piece.top, piece[i].x + piece.left);
	}
}

function drawpiece(piece) {
	for (var i = 0; i < 4; i++) {
		setblock(piece[i].y + piece.top, piece[i].x + piece.left, "current " + piece.type);
	}
}

function lockpiece(piece) {
	for (var i = 0; i < 4; i++) {
		setblock(piece[i].y + piece.top, piece[i].x + piece.left, piece.type);
	}
}

function checklines() {
	var cleared = clearlines();
	if (cleared > 0) {
		window.score += scores[cleared];
		window.lines += cleared;
		updatescore();
	}
}

function hascollision(piece) {
	for (var i = 0; i < 4; i++) {
		var block = blocktype(piece.top + piece[i].y, piece.left + piece[i].x);
		if (block != "" && !block.includes("current")) {
			return true;
		}
	}
	return false;
}

function advance() {
	if (currentpiece.top + currentpiece.height == fieldheight - 1) {
		lockpiece(currentpiece);
		currentpiece = nextpiece();
		checklines();
		drawpiece(currentpiece);
		return;
	}

	clearpiece(currentpiece);
	currentpiece.top++;

	if (hascollision(currentpiece)) {
		currentpiece.top--;
		lockpiece(currentpiece);
		checklines();
		currentpiece = nextpiece();
		drawpiece(currentpiece);
		if (hascollision(currentpiece)) {
			gameover();
		}
		return;
	}

	drawpiece(currentpiece);
}

function left() {
	cleartimer();
	clearpiece(currentpiece);
	currentpiece.left--;
	if (currentpiece.left < 0 || hascollision(currentpiece)) {
		currentpiece.left++;
	}
	drawpiece(currentpiece);
	settimer();
}

function right() {
	cleartimer();
	clearpiece(currentpiece);
	currentpiece.left++;
	if (currentpiece.left + currentpiece.width >= fieldwidth || hascollision(currentpiece)) {
		currentpiece.left--;
	}
	drawpiece(currentpiece);
	settimer();
}

function softdrop() {
	cleartimer();
	advance();
	settimer();
}

function harddrop() {
}

function rotate(dir) {
	cleartimer();
	clearpiece(currentpiece);

	currentpiece.rotation += dir;
	if (currentpiece.rotation < 0) {
		currentpiece.rotation = rotations[currentpiece.type].length - 1;
	} else if (currentpiece.rotation >= rotations[currentpiece.type].length) {
		currentpiece.rotation = 0;
	}

	for (var i = 0; i < 4; i++) {
		currentpiece[i].y = rotations[currentpiece.type][currentpiece.rotation][i].y;
		currentpiece[i].x = rotations[currentpiece.type][currentpiece.rotation][i].x;
	}
	getbounds(currentpiece);
	/* FIXME: check for out of bounds and collisions */
	drawpiece(currentpiece);
	settimer();
}

function touchstart(e) {
	e.preventDefault();
	console.log("start"); console.log(e.touches[0]);
	window.touchx = e.touches[0].screenX;
	window.touchy = e.touches[0].screenY;
}

function touchend(e) {
	e.preventDefault();
	var dx = window.touchx - e.changedTouches[0].screenX;
	var dy = window.touchy - e.changedTouches[0].screenY;
	if (dx > 10) {
		for (i = 0; i < dx / 10; i++) {
			left();
		}
	} else if (dx < -10) {
		for (i = 0; i < dx / -10; i++) {
			right();
		}
	} else if (dy < -10) {
		for (i = 0; i < dy / -10; i++) {
			advance();
		}
	} else {
		rotate(1);
	}
}

function startgame() {
	window.score = 0;
	window.lines = 0;
	updatescore();

	var go = document.getElementById("gameover");
	go.style.display = "none";

	for (var y = 0; y < fieldheight; y++) {
		for (var x = 0; x < fieldwidth; x++) {
			clearblock(y, x);
		}
	}

	window.onkeydown = function(e) {
		var key = e.keyCode ? e.keyCode : e.which;
		switch (key) {
		case 32: /* space */
		case 90: /* z */
			rotate(1);
			break;

		case 88: /* x */
			rotate(-1);
			break;

		case 27: /* escape */
			gameover();
			break;
		
		case 37: /* left */
		case 87: /* w */
			left();
			break;

		case 38: /* up */
			harddrop();
			break;

		case 39: /* right */
		case 83: /* d */
			right();
			break;

		case 40: /* down */
		case 65: /* s */
			softdrop();
			break;

                default:
			console.log(key);
                }
        }

	window.onclick = undefined;

	var span = document.getElementsByTagName("span");

	for (var i = 0; i < span.length; i++) {
		//span[i].addEventListener('touchmove', swipe, false);
		span[i].addEventListener('touchstart', touchstart, false);
		//span[i].addEventListener('touchcancel', swipe, false);
		span[i].addEventListener('touchend', touchend, false);
	}

	currentpiece = nextpiece();
	drawpiece(currentpiece);
	settimer();
}

function resize() {
	window.blocksize = Math.floor(Math.min(window.innerWidth / fieldwidth, window.innerHeight / (fieldheight+1)));
	for (var y = 0; y < fieldheight; y++) {
		for (var x = 0; x < fieldwidth; x++) {
			var b = getblock(y, x);
			b.style.width = (window.blocksize - 2) + "px";
			b.style.height = (window.blocksize - 2) + "px";
		}
	}
	var field = document.getElementById("playfield");
	field.style.width = (fieldwidth * window.blocksize) + "px";
	field.style.height = (fieldheight * window.blocksize) + "px";
	for (var i = 0; i < field.children.length; i++) {
		field.children[i].style.height = window.blocksize + "px";
	}

	var go = document.getElementById("gameover");
	go.style.width = (fieldwidth * window.blocksize) + "px";
	go.style.height = (fieldheight * window.blocksize) + "px";
	go.style.fontSize = (window.blocksize * 4) + "px";

	var sb = document.getElementById("scoreboard");
	sb.style.width = (fieldwidth * window.blocksize) + "px";

	if (window.innerWidth > window.innerHeight) {
		/* wide */
	} else {
		/* tall */
	}
}

function reinit() {
	resize();
	window.onresize = resize;
	window.onkeydown = function(e) {
		var key = e.keyCode ? e.keyCode : e.which;
		switch (key) {
		case 32: /* space */
		case 13: /* enter */
		case 83: /* 's' */
			startgame();
			break;

                default:
			//console.log(key);
                }
        }
	window.onclick = startgame;
}

function init() {
	var body = document.getElementsByTagName("body")[0];
	var playfield = document.createElement("div");
	playfield.id = "playfield";

	for (var i = 0; i < fieldheight; i++) {
		var row = document.createElement("div");
		row.className = "row";
		for (var j = 0; j < fieldwidth; j++) {
			var block = document.createElement("span");
			block.id = i + "-" + j;
			row.appendChild(block);
		}
		playfield.appendChild(row);
       	}
	body.appendChild(playfield);

	reinit();
}
</script>
</head>
<body onload="init();">
<div id="scoreboard">
<div>Score: <div id="score">0</div></div>
<div>Lines: <div id="lines">0</div></div>
</div>
<div id="gameover">Game over</div>
</div>
<!-- <audio src="Korobeiniki.mp3" autoplay loop></audio> -->
</body>
</html>
