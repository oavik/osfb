<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Falling Blocks</title>
<style type="text/css">
* { margin: 0; padding: 0; border: 0; }
span { display: inline-block; border: 1px solid black; }
.i { background: cyan; }
.j { background: blue; }
.l { background: orange; }
.o { background: yellow; }
.s { background: lime; }
.t { background: purple; }
.z { background: red; }
#playfield { background: black; margin-left: auto; margin-right: auto; }
#gameover { display: none; margin-left: auto; margin-right: auto; position: fixed; top: 0; color: white; text-align: center; text-shadow: 1px 1px black; }
#scoreboard { background: black; margin-left: auto; margin-right: auto; color: white; }
#scoreboard div { display: inline; }
#scoreboard div + div { float: right; }
</style>
<script type="text/javascript">
var fieldwidth = 10;
var fieldheight = 20;
var currentpiece = undefined;
var scores = [ 0, 100, 200, 400, 800 ];

var rotations = {
	i: [ [ { y: 0, x: 0 }, { y: 1, x: 0 }, { y: 2, x: 0 }, { y: 3, x: 0 } ],
	     [ { y: 0, x: 0 }, { y: 0, x: 1 }, { y: 0, x: 2 }, { y: 0, x: 3 } ] ],
	j: [ [ { y: 0, x: 0 }, { y: 0, x: 1 }, { y: 0, x: 2 }, { y: 1, x: 2 } ],
	     [ { y: 0, x: 1 }, { y: 1, x: 1 }, { y: 2, x: 0 }, { y: 2, x: 1 } ],
	     [ { y: 0, x: 0 }, { y: 1, x: 0 }, { y: 1, x: 1 }, { y: 1, x: 2 } ],
	     [ { y: 0, x: 0 }, { y: 0, x: 1 }, { y: 1, x: 0 }, { y: 2, x: 0 } ] ],
	l: [ [ { y: 0, x: 0 }, { y: 0, x: 1 }, { y: 0, x: 2 }, { y: 1, x: 0 } ],
	     [ { y: 0, x: 0 }, { y: 0, x: 1 }, { y: 1, x: 1 }, { y: 2, x: 1 } ],
	     [ { y: 0, x: 2 }, { y: 1, x: 0 }, { y: 1, x: 1 }, { y: 1, x: 2 } ],
	     [ { y: 0, x: 0 }, { y: 1, x: 0 }, { y: 2, x: 0 }, { y: 2, x: 1 } ] ],
	o: [ [ { y: 0, x: 0 }, { y: 0, x: 1 }, { y: 1, x: 0 }, { y: 1, x: 1 } ] ],
	s: [ [ { y: 0, x: 1 }, { y: 0, x: 2 }, { y: 1, x: 0 }, { y: 1, x: 1 } ],
	     [ { y: 0, x: 0 }, { y: 1, x: 0 }, { y: 1, x: 1 }, { y: 2, x: 1 } ] ],
	t: [ [ { y: 0, x: 0 }, { y: 0, x: 1 }, { y: 0, x: 2 }, { y: 1, x: 1 } ],
	     [ { y: 0, x: 1 }, { y: 1, x: 0 }, { y: 1, x: 1 }, { y: 2, x: 1 } ],
	     [ { y: 0, x: 1 }, { y: 1, x: 0 }, { y: 1, x: 1 }, { y: 1, x: 2 } ],
	     [ { y: 0, x: 0 }, { y: 1, x: 0 }, { y: 1, x: 1 }, { y: 2, x: 0 } ] ],
	z: [ [ { y: 0, x: 0 }, { y: 0, x: 1 }, { y: 1, x: 1 }, { y: 1, x: 2 } ],
	     [ { y: 0, x: 1 }, { y: 1, x: 0 }, { y: 1, x: 1 }, { y: 2, x: 0 } ] ]
};

function getbounds(piece) {
	piece.height = 0;
	piece.width = 0;
	for (var i = 0; i < 4; i++) {
		if (piece[i].y > piece.height) { piece.height = piece[i].y; }
		if (piece[i].x > piece.width) { piece.width = piece[i].x; }
	}
}

function nextpiece() {
	var pieces = [ 'i', 'j', 'l', 'o', 's', 't', 'z' ];
	var piece = {};
	piece.type = pieces[Math.floor(Math.random() * pieces.length)];
	piece.left = 0;
	piece.right = 0;
	piece.top = 0;
	piece.rotation = 0;
	for (var i = 0; i < 4; i++) {
		piece[i] = { y: rotations[piece.type][0][i].y, x: rotations[piece.type][0][i].x };
	}
	getbounds(piece);
	piece.left = Math.floor((fieldwidth / 2) - (piece.width / 2));
	return piece;
}

function cleartimer() { window.clearInterval(window.timer); }
function settimer() { window.timer = window.setInterval(advance, 500); }
function getblock(y, x) { return document.getElementById(y + "-" + x); }
function blocktype(y, x) { return getblock(y,x).className; }
function clearblock(y, x) { if (getblock(y, x)) { getblock(y, x).className = ""; } }
function setblock(y, x, t) { getblock(y, x).className = t; }

function gameover() {
	cleartimer();
	init();
	var go = document.getElementById("gameover");
	go.style.display = "block";
}

function clearline(y) {
	for (var x = 0; x < fieldwidth; x++) {
		if (blocktype(y, x) == "") {
			return 0;
		}
	}
	while (y > 0) {
		for (var x = 0; x < fieldwidth; x++) {
			setblock(y, x, blocktype(y - 1, x));
		}
		y--;
	}
	for (var x = 0; x < fieldwidth; x++) {
		clearblock(0, x);
	}
	return 1;
}


function clearlines() {
	var lines = 0;
	for (var y = 0; y < fieldheight; y++) {
		lines += clearline(y);
	}
	return lines;
}

function updatescore() {
	document.getElementById("score").innerHTML = window.score;
	document.getElementById("lines").innerHTML = window.lines;
}

function clearpiece(piece) {
	for (var i = 0; i < 4; i++) {
		clearblock(piece[i].y + piece.top, piece[i].x + piece.left);
	}
}

function drawpiece(piece) {
	for (var i = 0; i < 4; i++) {
		setblock(piece[i].y + piece.top, piece[i].x + piece.left, "current " + piece.type);
	}
}

function lockpiece(piece) {
	for (var i = 0; i < 4; i++) {
		setblock(piece[i].y + piece.top, piece[i].x + piece.left, piece.type);
	}
}

function checklines() {
	var cleared = clearlines();
	if (cleared > 0) {
		window.score += scores[cleared];
		window.lines += cleared;
		updatescore();
	}
}

function advance() {
	if (currentpiece.top + currentpiece.height == fieldheight - 1) {
		lockpiece(currentpiece);
		currentpiece = nextpiece();
		checklines();
		drawpiece(currentpiece);
		return;
	}

	for (var i = 0; i < 4; i++) {
		var below = blocktype(currentpiece.top + currentpiece[i].y + 1, currentpiece.left + currentpiece[i].x);
		if (below != "" && !below.includes("current")) {
			lockpiece(currentpiece);
			currentpiece = nextpiece();
			for (var i = 0; i < 4; i++) {
				if (blocktype(currentpiece[i].y, currentpiece[i].x) != "") {
					gameover();
					return;
				}
			}
			
			checklines();
			drawpiece(currentpiece);
			return;
		}
	}

	clearpiece(currentpiece);
	currentpiece.top++;
	drawpiece(currentpiece);
}

function left() {
	cleartimer();
	if (currentpiece.left < 1) {
		settimer();
		return;
	}
	for (var i = 0; i < 4; i++) {
		var left = blocktype(currentpiece.top + currentpiece[i].y, currentpiece.left + currentpiece[i].x - 1);
		if (left != "" && !left.includes("current")) {
			settimer();
			return;
		}
	}
	clearpiece(currentpiece);
	currentpiece.left--;
	drawpiece(currentpiece);
	settimer();
}

function right() {
	cleartimer();
	if (currentpiece.left + currentpiece.width >= fieldwidth - 1) {
		settimer();
		return;
	}
	for (var i = 0; i < 4; i++) {
		var right = blocktype(currentpiece.top + currentpiece[i].y, currentpiece.left + currentpiece[i].x + 1);
		if (right != "" && !right.includes("current")) {
			settimer();
			return;
		}
	}
	clearpiece(currentpiece);
	currentpiece.left++;
	drawpiece(currentpiece);
	settimer();
}

function softdrop() {
	cleartimer();
	advance();
	settimer();
}

function harddrop() {
}

function rotate(dir) {
	cleartimer();
	clearpiece(currentpiece);

	currentpiece.rotation += dir;
	if (currentpiece.rotation < 0) {
		currentpiece.rotation = rotations[currentpiece.type].length - 1;
	} else if (currentpiece.rotation >= rotations[currentpiece.type].length) {
		currentpiece.rotation = 0;
	}

	for (var i = 0; i < 4; i++) {
		currentpiece[i].y = rotations[currentpiece.type][currentpiece.rotation][i].y;
		currentpiece[i].x = rotations[currentpiece.type][currentpiece.rotation][i].x;
	}
	getbounds(currentpiece);
	/* FIXME: check for out of bounds and collisions */
	drawpiece(currentpiece);
	settimer();
}

function startgame() {
	window.score = 0;
	window.lines = 0;
	updatescore();

	var go = document.getElementById("gameover");
	go.style.display = "none";

	for (var y = 0; y < fieldheight; y++) {
		for (var x = 0; x < fieldwidth; x++) {
			clearblock(y, x);
		}
	}

	window.onkeydown = function(e) {
		var key = e.keyCode ? e.keyCode : e.which;
		switch (key) {
		case 32: /* space */
		case 90: /* z */
			rotate(1);
			break;

		case 88: /* x */
			rotate(-1);
			break;

		case 27: /* escape */
			gameover();
			break;
		
		case 37: /* left */
		case 87: /* w */
			left();
			break;

		case 38: /* up */
			harddrop();
			break;

		case 39: /* right */
		case 83: /* d */
			right();
			break;

		case 40: /* down */
		case 65: /* s */
			softdrop();
			break;

                default:
			console.log(key);
                }
        }
	currentpiece = nextpiece();
	drawpiece(currentpiece);
	settimer();
}

function resize() {
	var size = Math.floor(Math.min(window.innerWidth / fieldwidth, window.innerHeight / (fieldheight+1)));
	for (var y = 0; y < fieldheight; y++) {
		for (var x = 0; x < fieldwidth; x++) {
			var b = getblock(y, x);
			b.style.width = (size - 2) + "px";
			b.style.height = (size - 2) + "px";
		}
	}
	var field = document.getElementById("playfield");
	field.style.width = (fieldwidth * size) + "px";
	field.style.height = (fieldheight * size) + "px";
	for (var i = 0; i < field.children.length; i++) {
		field.children[i].style.height = size + "px";
	}

	var go = document.getElementById("gameover");
	go.style.width = (fieldwidth * size) + "px";
	go.style.height = (fieldheight * size) + "px";
	go.style.fontSize = (size * 4) + "px";

	var sb = document.getElementById("scoreboard");
	sb.style.width = (fieldwidth * size) + "px";

	if (window.innerWidth > window.innerHeight) {
		/* wide */
	} else {
		/* tall */
	}
}

function init() {
	resize();
	window.onresize = resize;
	window.onkeydown = function(e) {
		var key = e.keyCode ? e.keyCode : e.which;
		switch (key) {
		case 32: /* space */
		case 13: /* enter */
		case 83: /* 's' */
			startgame();
			break;

                default:
			//console.log(key);
                }
        }
}
</script>
</head>
<body onload="init();">
<div id="scoreboard">
<div>Score: <div id="score">0</div></div>
<div>Lines: <div id="lines">0</div></div>
</div>
<div id="playfield">
<div class="row"><span id="0-0"></span><span id="0-1"></span><span id="0-2"></span><span id="0-3"></span><span id="0-4"></span><span id="0-5"></span><span id="0-6"></span><span id="0-7"></span><span id="0-8"></span><span id="0-9"></span></div>
<div class="row"><span id="1-0"></span><span id="1-1"></span><span id="1-2"></span><span id="1-3"></span><span id="1-4"></span><span id="1-5"></span><span id="1-6"></span><span id="1-7"></span><span id="1-8"></span><span id="1-9"></span></div>
<div class="row"><span id="2-0"></span><span id="2-1"></span><span id="2-2"></span><span id="2-3"></span><span id="2-4"></span><span id="2-5"></span><span id="2-6"></span><span id="2-7"></span><span id="2-8"></span><span id="2-9"></span></div>
<div class="row"><span id="3-0"></span><span id="3-1"></span><span id="3-2"></span><span id="3-3"></span><span id="3-4"></span><span id="3-5"></span><span id="3-6"></span><span id="3-7"></span><span id="3-8"></span><span id="3-9"></span></div>
<div class="row"><span id="4-0"></span><span id="4-1"></span><span id="4-2"></span><span id="4-3"></span><span id="4-4"></span><span id="4-5"></span><span id="4-6"></span><span id="4-7"></span><span id="4-8"></span><span id="4-9"></span></div>
<div class="row"><span id="5-0"></span><span id="5-1"></span><span id="5-2"></span><span id="5-3"></span><span id="5-4"></span><span id="5-5"></span><span id="5-6"></span><span id="5-7"></span><span id="5-8"></span><span id="5-9"></span></div>
<div class="row"><span id="6-0"></span><span id="6-1"></span><span id="6-2"></span><span id="6-3"></span><span id="6-4"></span><span id="6-5"></span><span id="6-6"></span><span id="6-7"></span><span id="6-8"></span><span id="6-9"></span></div>
<div class="row"><span id="7-0"></span><span id="7-1"></span><span id="7-2"></span><span id="7-3"></span><span id="7-4"></span><span id="7-5"></span><span id="7-6"></span><span id="7-7"></span><span id="7-8"></span><span id="7-9"></span></div>
<div class="row"><span id="8-0"></span><span id="8-1"></span><span id="8-2"></span><span id="8-3"></span><span id="8-4"></span><span id="8-5"></span><span id="8-6"></span><span id="8-7"></span><span id="8-8"></span><span id="8-9"></span></div>
<div class="row"><span id="9-0"></span><span id="9-1"></span><span id="9-2"></span><span id="9-3"></span><span id="9-4"></span><span id="9-5"></span><span id="9-6"></span><span id="9-7"></span><span id="9-8"></span><span id="9-9"></span></div>
<div class="row"><span id="10-0"></span><span id="10-1"></span><span id="10-2"></span><span id="10-3"></span><span id="10-4"></span><span id="10-5"></span><span id="10-6"></span><span id="10-7"></span><span id="10-8"></span><span id="10-9"></span></div>
<div class="row"><span id="11-0"></span><span id="11-1"></span><span id="11-2"></span><span id="11-3"></span><span id="11-4"></span><span id="11-5"></span><span id="11-6"></span><span id="11-7"></span><span id="11-8"></span><span id="11-9"></span></div>
<div class="row"><span id="12-0"></span><span id="12-1"></span><span id="12-2"></span><span id="12-3"></span><span id="12-4"></span><span id="12-5"></span><span id="12-6"></span><span id="12-7"></span><span id="12-8"></span><span id="12-9"></span></div>
<div class="row"><span id="13-0"></span><span id="13-1"></span><span id="13-2"></span><span id="13-3"></span><span id="13-4"></span><span id="13-5"></span><span id="13-6"></span><span id="13-7"></span><span id="13-8"></span><span id="13-9"></span></div>
<div class="row"><span id="14-0"></span><span id="14-1"></span><span id="14-2"></span><span id="14-3"></span><span id="14-4"></span><span id="14-5"></span><span id="14-6"></span><span id="14-7"></span><span id="14-8"></span><span id="14-9"></span></div>
<div class="row"><span id="15-0"></span><span id="15-1"></span><span id="15-2"></span><span id="15-3"></span><span id="15-4"></span><span id="15-5"></span><span id="15-6"></span><span id="15-7"></span><span id="15-8"></span><span id="15-9"></span></div>
<div class="row"><span id="16-0"></span><span id="16-1"></span><span id="16-2"></span><span id="16-3"></span><span id="16-4"></span><span id="16-5"></span><span id="16-6"></span><span id="16-7"></span><span id="16-8"></span><span id="16-9"></span></div>
<div class="row"><span id="17-0"></span><span id="17-1"></span><span id="17-2"></span><span id="17-3"></span><span id="17-4"></span><span id="17-5"></span><span id="17-6"></span><span id="17-7"></span><span id="17-8"></span><span id="17-9"></span></div>
<div class="row"><span id="18-0"></span><span id="18-1"></span><span id="18-2"></span><span id="18-3"></span><span id="18-4"></span><span id="18-5"></span><span id="18-6"></span><span id="18-7"></span><span id="18-8"></span><span id="18-9"></span></div>
<div class="row"><span id="19-0"></span><span id="19-1"></span><span id="19-2"></span><span id="19-3"></span><span id="19-4"></span><span id="19-5"></span><span id="19-6"></span><span id="19-7"></span><span id="19-8"></span><span id="19-9"></span></div>
<div id="gameover">Game over</div>
</div>
<!-- <audio src="Korobeiniki.mp3" autoplay loop></audio> -->
</body>
</html>
